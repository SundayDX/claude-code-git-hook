# Context
Filename: TASK-fix-query-api.md
Created On: 2025-11-04T13:50:00Z
Created By: AI Assistant
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
修复 Claude Agent SDK `query()` API 调用错误。当前代码错误地将 `query()` 返回的异步生成器当作字符串处理，导致 `result.trim is not a function` 错误。需要正确遍历异步生成器，从 `SDKResultMessage` 中提取 `result` 字段。

错误日志：
```
[2025-11-04T13:44:43.528Z] [WARN] ⚠️ 第 1 次尝试失败: result.trim is not a function
```

# Project Overview
`claude-code-git-hook` 是一个 Git Hook 工具，用于在 Claude Code 停止时自动创建 WIP commits，并提供合并 WIP commits 的功能。该工具使用 `@anthropic-ai/claude-agent-sdk` 来生成 commit 消息。

当前版本：v1.0.0
Node.js 版本要求：>=14.0.0

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)

## 问题根源
从代码分析和 TypeScript 定义文件可以确定：
1. `@anthropic-ai/claude-agent-sdk` 的 `query()` 函数返回 `Query` 类型，它是 `AsyncGenerator<SDKMessage, void>` 的扩展接口
2. 当前代码（`src/auto-commit.js:86-94` 和 `src/splash.js:92-100`）错误地将返回值当作字符串直接调用 `.trim()`
3. 正确的用法是遍历异步生成器，从 `type === 'result'` 的消息中提取 `result` 字段

## 受影响的文件
1. **src/auto-commit.js**
   - 函数：`generateCommitMessage()` (第 72-142 行)
   - 问题位置：第 86-94 行
   - 调用点：第 299 行

2. **src/splash.js**
   - 函数：`generateMergedCommitMessage()` (第 70-147 行)
   - 问题位置：第 92-100 行
   - 调用点：第 371 行

## SDK 类型定义
根据 `sdk.d.ts` 分析：
- `SDKResultMessage` 有两种子类型：
  - `subtype: 'success'` 包含 `result: string` 字段
  - `subtype: 'error_during_execution' | 'error_max_turns' | 'error_max_budget_usd'` 包含 `errors: string[]` 字段

## 关键依赖
- `@anthropic-ai/claude-agent-sdk`: ^0.1.0 (实际安装版本：0.1.30)
- 导入语句：`import { query } from '@anthropic-ai/claude-agent-sdk';`

# Proposed Solution (Populated by INNOVATE mode)

采用**方案一：正确遍历异步生成器获取结果**

## 技术方案
1. 修改 `query()` 调用方式，传入正确的参数对象格式：`{ prompt, options }`
2. 使用 `for await...of` 遍历异步生成器
3. 检查消息类型，提取 `SDKResultMessage` 中的结果
4. 处理成功和失败两种情况
5. 保留原有的超时机制和重试逻辑

## 实现细节
- 成功时：从 `message.result` 获取字符串结果
- 失败时：从 `message.errors` 获取错误信息并抛出异常
- 超时处理：使用 `Promise.race()` 结合 `AbortController` 实现超时中断

## 优点
- 符合 SDK 官方 API 设计
- 能正确处理错误情况
- 可扩展性强（未来可以处理流式输出）

# Implementation Plan (Generated by PLAN mode)

## 变更概述
需要修改两个文件中的生成消息函数，将错误的 `query()` 调用方式改为正确的异步生成器处理方式。

## 详细修改计划

### 修改 1: src/auto-commit.js - generateCommitMessage 函数
**文件**: `src/auto-commit.js`
**函数**: `generateCommitMessage` (第 72-142 行)
**理由**: 修复 `query()` API 调用错误，正确处理异步生成器

**具体修改**:
1. 修改第 82-112 行的 try 块内容
2. 将 `query(prompt)` 改为 `query({ prompt })`
3. 添加异步生成器遍历逻辑
4. 使用 `AbortController` 实现超时控制
5. 从 `SDKResultMessage` 中提取 `result` 字段
6. 保持原有的消息清理和格式化逻辑

**代码结构**:
```javascript
// 创建 AbortController 用于超时控制
const abortController = new AbortController();
const timeoutId = setTimeout(() => abortController.abort(), timeout);

try {
  // 调用 query API
  const queryResult = query({ 
    prompt,
    options: {
      abortController,
      cwd: process.cwd(),
    }
  });
  
  // 遍历异步生成器
  let result = null;
  for await (const message of queryResult) {
    if (message.type === 'result') {
      if (message.subtype === 'success') {
        result = message.result;
        break;
      } else {
        // 处理错误情况
        throw new Error(message.errors?.join(', ') || 'Query failed');
      }
    }
  }
  
  clearTimeout(timeoutId);
  
  if (!result) {
    throw new Error('No result from query');
  }
  
  // 原有的消息处理逻辑保持不变
  let message = result.trim();
  // ... 后续处理
} catch (error) {
  clearTimeout(timeoutId);
  // 原有的错误处理逻辑
}
```

### 修改 2: src/splash.js - generateMergedCommitMessage 函数
**文件**: `src/splash.js`
**函数**: `generateMergedCommitMessage` (第 70-147 行)
**理由**: 同样需要修复 `query()` API 调用错误

**具体修改**:
1. 修改第 88-110 行的 try 块内容
2. 应用与 `auto-commit.js` 相同的修改模式
3. 保持原有的消息清理逻辑（移除前缀、过滤空行等）

**代码结构**: 与修改 1 相同的模式

### 修改 3: 错误处理优化
**理由**: 提供更清晰的错误信息用于调试

**具体内容**:
1. 在捕获异常时，区分超时错误和 API 错误
2. 对于 `AbortError`，提供 "Timeout" 错误信息
3. 对于其他错误，保留原始错误信息

## 依赖关系
- 修改 1 和修改 2 可以并行进行
- 修改 3 是修改 1 和 2 的一部分

## 测试验证
修改完成后需要验证：
1. 自动 commit 功能能正常生成消息
2. squash-wip 功能能正常合并 commits
3. 超时机制工作正常
4. 错误情况能正确回退到后备方案

## 实施检查清单

```
Implementation Checklist:
1. 修改 src/auto-commit.js 中的 generateCommitMessage 函数，将 query() 调用改为正确的异步生成器处理方式
2. 修改 src/splash.js 中的 generateMergedCommitMessage 函数，应用相同的修复模式
3. 测试 auto-commit 功能是否正常工作
4. 测试 squash-wip 功能是否正常工作
5. 验证错误处理和超时机制
```

# Current Execution Step (Updated by EXECUTE mode when starting a step)
> 已完成步骤 1 和 2，等待用户测试确认

# Task Progress (Appended by EXECUTE mode after each step completion)
*   [2025-11-04T13:52:00Z]
    *   Step: 清单项 1 - 修改 src/auto-commit.js 中的 generateCommitMessage 函数
    *   Modifications: 
        - 文件: src/auto-commit.js (第 82-148 行)
        - 将 `query(prompt)` 改为 `query({ prompt, options })`
        - 使用 `AbortController` 实现超时控制
        - 添加 `for await...of` 遍历异步生成器
        - 从 `message.type === 'result'` 中提取 `result` 字段
        - 处理成功和错误两种情况（`subtype: 'success'` 和 `errors[]`）
        - 区分 AbortError 为 Timeout 错误
        - 保留原有的消息清理和格式化逻辑
    *   Change Summary: 修复了 Claude Agent SDK query() API 的调用方式，从错误的字符串处理改为正确的异步生成器遍历
    *   Reason: 执行计划步骤 1
    *   Blockers: 无
    *   User Confirmation Status: 待确认

*   [2025-11-04T13:52:00Z]
    *   Step: 清单项 2 - 修改 src/splash.js 中的 generateMergedCommitMessage 函数
    *   Modifications:
        - 文件: src/splash.js (第 88-147 行)
        - 应用与 auto-commit.js 相同的修复模式
        - 将 `query(prompt)` 改为 `query({ prompt, options })`
        - 使用 `AbortController` 实现超时控制
        - 添加异步生成器遍历逻辑
        - 从 SDKResultMessage 中提取 result 字段
        - 处理成功和错误情况
        - 保留原有的消息清理逻辑（移除前缀、过滤空行）
    *   Change Summary: 应用相同的 API 修复到 squash-wip 功能
    *   Reason: 执行计划步骤 2
    *   Blockers: 无
    *   User Confirmation Status: 待确认

# Final Review (Populated by REVIEW mode)
*待完成*

